pipeline {
    agent any

    environment {
        scannerHome = "C:\\sonar\\sonarqube\\bin\\sonar-scanner-msbuild-4.6+\\SonarScanner.MSBuild.dll"
        projectFile = "C:\\tmp\\dotnet-app\\Assessment.API\\Assessment.API.csproj"
    }

    stages {
        stage('SCM') {
            steps {
                checkout scm
            }
        }

        stage('Build and SonarQube Analysis') {
            steps {
                bat "\"C:\\Program Files\\dotnet\\dotnet.exe\" build \"${projectFile}\""

                withSonarQubeEnv('SonarQube servers') {
                    bat "\"${scannerHome}\\SonarScanner.MSBuild.dll\" begin /k:\".net-code\""
                    bat "\"C:\\Program Files\\dotnet\\dotnet.exe\" build \"${projectFile}\""
                    bat "\"${scannerHome}\\SonarScanner.MSBuild.dll\" end"
                }
            }
        }
    }
}
